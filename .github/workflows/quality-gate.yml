name: Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  statuses: write
  contents: read

jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -e ".[dev]"
      
      - name: Quality checks
        id: quality
        run: |
          set +e  # Don't exit on error, capture status
          
          # Check formatting
          ruff format --check . > format-check.log 2>&1
          FORMAT_STATUS=$?
          
          # Check linting
          ruff check . --output-format=json > ruff-report.json 2>&1
          LINT_STATUS=$?
          
          # Run tests
          pytest --quiet --tb=short > test-results.log 2>&1
          TEST_STATUS=$?
          
          # Calculate violations
          ERROR_COUNT=$(jq '[.[] | select(.level == "error")] | length' ruff-report.json 2>/dev/null || echo "0")
          
          # Determine overall status
          if [ $FORMAT_STATUS -eq 0 ] && [ $LINT_STATUS -eq 0 ] && [ $TEST_STATUS -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=All quality checks passed ✅" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Quality gate failed. $ERROR_COUNT Ruff violations found. Comment '/fix' to auto-correct." >> $GITHUB_OUTPUT
          fi
          
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
      
      - name: Update commit status
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.quality.outputs.status }}';
            const message = '${{ steps.quality.outputs.message }}';
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: status,
              context: 'Quality Gate',
              description: message,
              target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });
      
      - name: Block PR if failed
        if: steps.quality.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const errorCount = '${{ steps.quality.outputs.error_count }}';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ⛔ Quality Gate Failed

**Status:** ${errorCount} violations detected

**Actions Required:**
1. Comment \`/fix\` to automatically apply Ruff fixes
2. Review and commit any remaining manual fixes
3. Ensure all tests pass locally with \`pytest\`

**Quality Standards:**
- ✅ Ruff formatting compliance
- ✅ Zero Ruff lint violations  
- ✅ All tests passing
- ✅ Sense isolation maintained

This PR cannot be merged until all checks pass.`
            });
            
            core.setFailed('Quality gate failed');
