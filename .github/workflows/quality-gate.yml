name: Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  statuses: write
  contents: read

jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -e ".[dev]"
      
      - name: Quality checks
        id: quality
        run: |
          set +e  # Don't exit on error, capture status
          
          # Check formatting
          ruff format --check . > format-check.log 2>&1
          FORMAT_STATUS=$?
          
          # Check linting
          ruff check . --output-format=json > ruff-report.json 2>&1
          LINT_STATUS=$?
          
          # Run tests
          pytest --quiet --tb=short > test-results.log 2>&1
          TEST_STATUS=$?
          
          # Build status message
          FAILURES=""
          if [ $FORMAT_STATUS -ne 0 ]; then
            FAILURES="${FAILURES}formatting, "
          fi
          if [ $LINT_STATUS -ne 0 ]; then
            FAILURES="${FAILURES}linting, "
          fi
          if [ $TEST_STATUS -ne 0 ]; then
            FAILURES="${FAILURES}tests, "
          fi
          FAILURES=${FAILURES%, }  # Remove trailing comma
          
          # Determine overall status
          if [ $FORMAT_STATUS -eq 0 ] && [ $LINT_STATUS -eq 0 ] && [ $TEST_STATUS -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=All quality checks passed ✅" >> $GITHUB_OUTPUT
            echo "failures=" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Quality gate failed: ${FAILURES}. Comment '/fix' for Ruff issues." >> $GITHUB_OUTPUT
            echo "failures=${FAILURES}" >> $GITHUB_OUTPUT
          fi
      
      - name: Update commit status
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.quality.outputs.status }}';
            const message = '${{ steps.quality.outputs.message }}';
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: status,
              context: 'Quality Gate',
              description: message,
              target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });
      
      - name: Block PR if failed
        if: steps.quality.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const failures = '${{ steps.quality.outputs.failures }}';
            const body = '## ⛔ Quality Gate Failed\n\n' +
              '**Failed Checks:** ' + failures + '\n\n' +
              '**Actions Required:**\n' +
              '1. For formatting/linting failures: Comment `/fix` to automatically apply Ruff fixes\n' +
              '2. For test failures: Fix tests locally and push changes\n' +
              '3. Run checks locally before pushing: `ruff check . && ruff format --check . && pytest`\n\n' +
              '**Quality Standards:**\n' +
              '- ✅ Ruff formatting compliance\n' +
              '- ✅ Zero Ruff lint violations  \n' +
              '- ✅ All tests passing\n' +
              '- ✅ Sense isolation maintained\n\n' +
              'This PR cannot be merged until all checks pass.';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
            core.setFailed('Quality gate failed');
